

### android 如何抓包

1.配置app，允许debug下抓包
   <?xml version="1.0" encoding="utf-8"?>
   <network-security-config>
       <debug-overrides>
           <trust-anchors>
               <!-- Trust user installed CA certificates in debug build -->
               <certificates src="user" />
           </trust-anchors>
       </debug-overrides>
   </network-security-config>
   <application
       ...
       android:networkSecurityConfig="@xml/network_security_config"
       ...>
       ...
   </application>

2.安装charles
https://www.charlesproxy.com/


3.手机设置代理到电脑
打开wifi高级设置，开启代理。输入电脑ip，和charles端口8888
（电脑ip，可以通过ipconfig命令看到，是wifi分配的ip）



给电脑安装证书
在Charles中，选择Help > SSL Proxying > Install Charles Root Certificate。安装后
给手机安装证书。
在Charles中，选择Help > SSL Proxying > Install Charles Root Certificate。安装后
(这个一定要打开链接到代理，才能下载。（而且每个电脑的证书都是不一样的，所以要链接其他电脑，要重新安装下载证书） 
下载后，打开设置-》wifi设置=》高级设置，安装证书。)
（设置中可以看到用户安装的证书，也可以看到预置的根证书。）

配置启用https监听
为了能够查看HTTPS通信，需要启用SSL代理设置。进入Proxy > SSL Proxying Settings，勾选Enable SSL Proxying，
并添加你需要监控的域名（不用加https://）和端口，通常端口是443（不添加是监听不到的）



34.打开app
即可看到流量，也可以开启过滤。

注意：如果是乱码，可能就是你SSL Proxying Settings 中监听的域名和端口配置错了。



### ca证书
证书颁发机构（Certificate Authority）证书，是数字证书的一种，用于在互联网通信中建立信任关系
CA证书由受信任的第三方机构颁发，用于确认网站或服务的身份。
CA证书包含公钥，用于SSL/TLS加密过程中的密钥交换（就是对称加密的秘钥交换）
客户端使用证书中的公钥加密信息，只有持有对应私钥的服务器才能解密 （反之亦然），从而保证了数据传输过程的安全性。
包含公钥、证书持有者的信息（如网站的域名）以及签发CA的签名。

#### 根ca
根CA是顶级证书颁发机构，其证书通常预装在操作系统或浏览器中。
根CA可以签发中间CA证书，中间CA再签发给终端实体（如网站）。通过这种方式，只要信任根CA，就可以通过信任链验证由其签发的任何证书的有效性。

#### 验证过程
1当用户访问一个使用SSL/TLS加密的网站时，网站会提供一个由CA签发的证书，里面包含公钥。及证书链中的所有中间证书（根证书通常不提供，因为它应该已经预装在客户端中）。

2客户端首先验证服务器证书的签名是否由列表中的中间CA证书颁发，然后再验证该中间CA证书的签名是否由另一个中间CA或根CA证书颁发，依此类推，直到达到一个预装的、信任的根CA证书。

3.如果信任此证书（验证了证书信任链），就用此证书交换密钥，后续就是对称加密了。

#### charles原理 
其实就是手机设置代理，然后手机中也安装了charles的根证书

这样app发送请求，到charles（模拟的服务端），charles返回一个证书。然后这个证书能被 刚才安装的charles的根证书验证。
交换秘钥，完成ssl 握手。  charles再模拟app端发送请求就好了。

破戒方式，
只要配置app是否信任用户安装的证书就可以了，release都是不信任的，所以验证不过。

在Android 7.0以前，如果用户在设备上安装了CA证书，所有应用默认都会信任这个证书。
这使得使用Charles这样的代理工具通过安装其自己的CA证书来解密HTTPS流量变得相对简单。
然而，从Android 7.0开始，应用默认只信任系统预装的CA证书，除非应用明确在其network_security_config.xml中配置为信任用户安装的CA证书。

### 其他方法
或者root，让系统默认信任用户安装的证书。




===========================ssl/tls四次握手
见drawable
https://blog.csdn.net/weixin_44045328/article/details/107179755
由于历史原因，SSL协议从SSL3.0之后改名为TLS，但是SSL依旧有些服务器在用，因此习惯上称之为SSL/TLS协议


* 1客户端告知服务端可使用的 几套加密算法（对称加密+非对称加密+hash算法）
  * 2.服务器返回选择的一套加密算法，和数字证书（CA颁发，里面用CA私钥加密了服务器的公钥和网站信息）
  * 3.客户端接收到，验证数字证书的合法性，用正规CA机构的公钥解密，成功则数字证书合法
  *   解密后得到服务器的公钥。
  *   此时客户端生成随机密码，然后用公钥加密，发送给服务端
  * 4.服务端 用私钥解密 得到随机密码。（此时只有客户端和服务端知道随机密码）
  *   然后服务端将握手消息用随机密码加密发送
  * 5.客户端用随机密码解密 握手消息。此时tls握手完成，客户端以后发送的数据都用随机密码加密后传输

TLS/SSL握手过程是建立加密通信的关键步骤，它确保数据在客户端和服务器之间安全传输。
这个过程涉及多个步骤，主要目的是让双方协商加密算法、验证对方身份，并交换加密密钥。以下是TLS/SSL握手的基本步骤：
一次握手：
1. 客户端Hello：握手开始时，客户端向服务器发送一个“Client Hello”消息，
其中包含客户端支持的TLS版本、加密算法列表、随机数（Client Random）等信息。

二次握手：
2. 服务器Hello：服务器收到“Client Hello”后，选择一个客户端也支持的TLS版本和加密套件，并发送一个“Server Hello”消息给客户端。
这个消息中包含服务器选择的TLS版本和加密套件、服务器随机数（Server Random）等信息。
3. 服务器证书：服务器发送其SSL证书给客户端。这个证书包含了服务器的公钥和证书颁发机构（CA）的签名。
客户端将验证证书的有效性，确保与预期的服务器通信。
4. （可选）服务器密钥交换：服务器可能会发送一个“Server Key Exchange”消息（取决于选定的加密套件），包含用于密钥交换的公钥信息。
5. （可选）请求客户端证书（可选）：如果服务器需要验证客户端的身份，它会请求客户端发送证书。

（此时客户端校验ca合法，验证本机预装的根证书）
三次握手：
6. 客户端密钥交换：客户端回应一个“Client Key Exchange”消息，包含预主密钥（Pre-Master Secret），这通常使用服务器的公钥加密，只有服务器能用自己的私钥解密。
7. （可选）证书验证（可选）：如果服务器请求了客户端证书，客户端会发送其证书给服务器。
8. 完成：客户端和服务器分别发送“Change Cipher Spec”消息，表明后续通信将使用协商的加密参数和密钥。
然后，双方各自发送“Finished”消息，这是第一个使用新加密参数加密的消息，对方验证这个消息以确认握手的完整性和安全性。
9. 加密通信：握手完成后，客户端和服务器开始使用协商的加密参数和密钥进行加密通信。
   整个TLS/SSL握手过程设计得非常精巧，既确保了通信的机密性（通过加密数据），也确保了通信双方的身份验证（通过证书），
并且还提供了数据完整性验证（通过消息认证码）。


==============随机数（Client Random）是干啥的
在TLS/SSL握手过程中，随机数（Client Random）和服务器随机数（Server Random）扮演着非常重要的角色。
它们共同用于生成会话密钥，这个密钥是双方进行加密通信的基础。下面是随机数在TLS/SSL握手中的作用和重要性：
生成会话密钥
确保每次握手的唯一性：客户端和服务器各自生成的随机数确保了每次TLS/SSL握手都是独一无二的。
即使是同一客户端和服务器多次进行握手，由于随机数的不同，每次生成的会话密钥也会不同。
这样可以防止重放攻击，即攻击者捕获并重新发送之前的消息尝试欺骗服务器或客户端。
协助生成主密钥：在TLS/SSL握手过程中，客户端随机数、服务器随机数以及预主密钥（Pre-Master Secret，由客户端生成并安全地发送给服务器）一起被用来生成主密钥（Master Secret）。
主密钥进一步用于生成会话密钥，这些会话密钥用于加密和解密客户端与服务器之间传输的数据。

增强安全性
防止预测攻击：使用随机数可以防止攻击者预测会话密钥的生成过程，从而增加了通信的安全性。
提供前向保密：即使在会话结束后某个会话密钥被破解，由于每次握手生成的会话密钥都是基于新的随机数，因此不会影响到其他会话的安全性。
总之，客户端随机数和服务器随机数是TLS/SSL安全握手过程的核心组成部分，它们确保了每次会话的唯一性和安全性，是生成会话密钥的关键因素。























